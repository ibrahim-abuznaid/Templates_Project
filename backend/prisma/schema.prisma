generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int             @id @default(autoincrement())
  username             String          @unique @db.VarChar(255)
  password             String          @db.VarChar(255)
  role                 String          @db.VarChar(50)
  email                String?         @db.VarChar(255)
  isActive             Boolean         @default(true) @map("is_active")
  createdAt            DateTime?       @default(now()) @map("created_at") @db.Timestamp(6)
  activities           ActivityLog[]
  blockers             Blocker[]
  comments             Comment[]
  assignedIdeas        Idea[]          @relation("IdeaAssignee")
  createdIdeas         Idea[]          @relation("IdeaCreator")
  invoices             Invoice[]
  notifications        Notification[]
  views                views[]
  suggestedIdeas       SuggestedIdea[] @relation("SuggestedByUser")
  reviewedSuggestions  SuggestedIdea[] @relation("ReviewedByUser")

  @@map("users")
}

model Idea {
  id               Int               @id @default(autoincrement())
  flowName         String?           @map("flow_name")
  summary          String?           // Brief summary for public library
  description      String?
  setupGuide       String?           @map("setup_guide")
  templateUrl      String?           @map("template_url")
  scribeUrl        String?           @map("scribe_url") // Sent as blogUrl to API
  timeSavePerWeek  String?           @map("time_save_per_week") @db.VarChar(100) // e.g., "2 hours"
  costPerYear      String?           @map("cost_per_year") @db.VarChar(100) // e.g., "$150/year"
  author           String?           @db.VarChar(255) // Template author for public library
  ideaNotes        String?           @map("idea_notes") @db.Text // Internal notes about the template idea
  flowJson         String?           @map("flow_json") @db.Text // JSON string for flow data uploaded by freelancer
  reviewerName     String?           @map("reviewer_name") @db.VarChar(255) // Internal only, not sent to API
  price            Decimal?          @db.Decimal(10, 2) // Internal only, not sent to API
  status           String?           @default("new") @db.VarChar(50)
  assignedTo       Int?              @map("assigned_to")
  createdBy        Int?              @map("created_by")
  publicLibraryId  String?           @map("public_library_id") // ID returned from publish API
  department       String?           @db.VarChar(100) // Deprecated: kept for backward compatibility
  useCase          String?           @map("use_case") // Deprecated: kept for backward compatibility
  shortDescription String?           @map("short_description") // Deprecated: use summary instead
  tags             String?           // Deprecated: use timeSavePerWeek and costPerYear instead
  createdAt        DateTime?         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime?         @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  activities       ActivityLog[]
  blockers         Blocker[]
  comments         Comment[]
  departments      IdeaDepartment[]
  assignee         User?             @relation("IdeaAssignee", fields: [assignedTo], references: [id], onUpdate: NoAction)
  creator          User?             @relation("IdeaCreator", fields: [createdBy], references: [id], onUpdate: NoAction)
  invoices         Invoice[]
  views            views[]
  fromSuggestion   SuggestedIdea[]   // Ideas created from approved suggestions

  @@index([assignedTo], map: "idx_ideas_assigned_to")
  @@index([createdBy], map: "idx_ideas_created_by")
  @@index([status], map: "idx_ideas_status")
  @@map("ideas")
}

model Comment {
  id        Int       @id @default(autoincrement())
  ideaId    Int?      @map("idea_id")
  userId    Int?      @map("user_id")
  comment   String
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  idea      Idea?     @relation(fields: [ideaId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User?     @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([ideaId], map: "idx_comments_idea_id")
  @@map("comments")
}

model ActivityLog {
  id        Int       @id @default(autoincrement())
  ideaId    Int?      @map("idea_id")
  userId    Int?      @map("user_id")
  action    String    @db.VarChar(255)
  details   String?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  idea      Idea?     @relation(fields: [ideaId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User?     @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([ideaId], map: "idx_activity_log_idea_id")
  @@map("activity_log")
}

model Invoice {
  id           Int       @id @default(autoincrement())
  idea_id      Int?
  freelancerId Int?      @map("freelancer_id")
  amount       Decimal   @db.Decimal(10, 2)
  status       String?   @default("pending") @db.VarChar(50)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  paidAt       DateTime? @map("paid_at") @db.Timestamp(6)
  freelancer   User?     @relation(fields: [freelancerId], references: [id], onUpdate: NoAction)
  ideas        Idea?     @relation(fields: [idea_id], references: [id], onUpdate: NoAction)

  @@map("invoices")
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int?      @map("user_id")
  title     String    @db.VarChar(255)
  message   String
  type      String?   @default("info") @db.VarChar(50)
  read      Boolean?  @default(false)
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_notifications_user_id")
  @@map("notifications")
}

model Blocker {
  id          Int       @id @default(autoincrement())
  ideaId      Int?      @map("idea_id")
  reported_by Int?
  title       String    @db.VarChar(255)
  description String
  severity    String?   @default("medium") @db.VarChar(50)
  status      String?   @default("open") @db.VarChar(50)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  resolvedAt  DateTime? @map("resolved_at") @db.Timestamp(6)
  idea        Idea?     @relation(fields: [ideaId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users       User?     @relation(fields: [reported_by], references: [id], onUpdate: NoAction)

  @@index([ideaId], map: "idx_blockers_idea_id")
  @@map("blockers")
}

model views {
  id         Int       @id @default(autoincrement())
  idea_id    Int?
  user_id    Int?
  view_date  DateTime? @default(dbgenerated("CURRENT_DATE")) @db.Date
  view_count Int?      @default(1)
  ideas      Idea?     @relation(fields: [idea_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users      User?     @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@unique([idea_id, user_id, view_date])
}

model Department {
  id               Int                       @id @default(autoincrement())
  name             String                    @unique @db.VarChar(100)
  description      String?
  displayOrder     Int                       @default(999) @map("display_order")
  createdAt        DateTime                  @default(now()) @map("created_at") @db.Timestamp(6)
  ideas            IdeaDepartment[]
  suggestedIdeas   SuggestedIdeaDepartment[]

  @@map("departments")
}

model IdeaDepartment {
  id           Int        @id @default(autoincrement())
  ideaId       Int        @map("idea_id")
  departmentId Int        @map("department_id")
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamp(6)
  idea         Idea       @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([ideaId, departmentId])
  @@index([ideaId], map: "idx_idea_departments_idea_id")
  @@index([departmentId], map: "idx_idea_departments_department_id")
  @@map("idea_departments")
}

model SuggestedIdea {
  id              Int                       @id @default(autoincrement())
  flowName        String                    @map("flow_name") @db.VarChar(255) // Same as ideas.flow_name
  ideaNotes       String?                   @map("idea_notes") @db.Text // Same as ideas.idea_notes
  status          String                    @default("pending") @db.VarChar(50) // pending, approved, denied
  suggestedBy     Int                       @map("suggested_by")
  reviewedBy      Int?                      @map("reviewed_by")
  reviewNote      String?                   @map("review_note") @db.Text // Admin's note when approving/denying
  convertedIdeaId Int?                      @map("converted_idea_id") // The idea ID if approved and converted
  createdAt       DateTime                  @default(now()) @map("created_at") @db.Timestamp(6)
  reviewedAt      DateTime?                 @map("reviewed_at") @db.Timestamp(6)
  suggestor       User                      @relation("SuggestedByUser", fields: [suggestedBy], references: [id], onUpdate: NoAction)
  reviewer        User?                     @relation("ReviewedByUser", fields: [reviewedBy], references: [id], onUpdate: NoAction)
  convertedIdea   Idea?                     @relation(fields: [convertedIdeaId], references: [id], onUpdate: NoAction)
  departments     SuggestedIdeaDepartment[]

  @@index([suggestedBy], map: "idx_suggested_ideas_suggested_by")
  @@index([status], map: "idx_suggested_ideas_status")
  @@map("suggested_ideas")
}

model SuggestedIdeaDepartment {
  id              Int           @id @default(autoincrement())
  suggestedIdeaId Int           @map("suggested_idea_id")
  departmentId    Int           @map("department_id")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamp(6)
  suggestedIdea   SuggestedIdea @relation(fields: [suggestedIdeaId], references: [id], onDelete: Cascade)
  department      Department    @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([suggestedIdeaId, departmentId])
  @@index([suggestedIdeaId], map: "idx_suggested_idea_departments_suggested_idea_id")
  @@index([departmentId], map: "idx_suggested_idea_departments_department_id")
  @@map("suggested_idea_departments")
}
